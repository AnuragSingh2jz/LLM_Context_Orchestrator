import{c as x,a as N}from"./serializer-DZ1wSGbK.js";import{p as _,c as V}from"./injector-Op4Q08O8.js";const w=(t,e)=>e.some(n=>t instanceof n);let C,S;function U(){return C||(C=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function $(){return S||(S=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const I=new WeakMap,h=new WeakMap,m=new WeakMap;function W(t){const e=new Promise((n,a)=>{const i=()=>{t.removeEventListener("success",d),t.removeEventListener("error",r)},d=()=>{n(f(t.result)),i()},r=()=>{a(t.error),i()};t.addEventListener("success",d),t.addEventListener("error",r)});return m.set(e,t),e}function K(t){if(I.has(t))return;const e=new Promise((n,a)=>{const i=()=>{t.removeEventListener("complete",d),t.removeEventListener("error",r),t.removeEventListener("abort",r)},d=()=>{n(),i()},r=()=>{a(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",d),t.addEventListener("error",r),t.addEventListener("abort",r)});I.set(t,e)}let E={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return I.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function O(t){E=t(E)}function R(t){return $().includes(t)?function(...e){return t.apply(T(this),e),f(this.request)}:function(...e){return f(t.apply(T(this),e))}}function H(t){return typeof t=="function"?R(t):(t instanceof IDBTransaction&&K(t),w(t,U())?new Proxy(t,E):t)}function f(t){if(t instanceof IDBRequest)return W(t);if(h.has(t))return h.get(t);const e=H(t);return e!==t&&(h.set(t,e),m.set(e,t)),e}const T=t=>m.get(t);function J(t,e,{blocked:n,upgrade:a,blocking:i,terminated:d}={}){const r=indexedDB.open(t,e),s=f(r);return a&&r.addEventListener("upgradeneeded",c=>{a(f(r.result),c.oldVersion,c.newVersion,f(r.transaction),c)}),n&&r.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),s.then(c=>{d&&c.addEventListener("close",()=>d()),i&&c.addEventListener("versionchange",u=>i(u.oldVersion,u.newVersion,u))}).catch(()=>{}),s}const Q=["get","getKey","getAll","getAllKeys","count"],X=["put","add","delete","clear"],b=new Map;function A(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(b.get(e))return b.get(e);const n=e.replace(/FromIndex$/,""),a=e!==n,i=X.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!(i||Q.includes(n)))return;const d=async function(r,...s){const c=this.transaction(r,i?"readwrite":"readonly");let u=c.store;return a&&(u=u.index(s.shift())),(await Promise.all([u[n](...s),i&&c.done]))[0]};return b.set(e,d),d}O(t=>({...t,get:(e,n,a)=>A(e,n)||t.get(e,n,a),has:(e,n)=>!!A(e,n)||t.has(e,n)}));const q=["continue","continuePrimaryKey","advance"],L={},D=new WeakMap,v=new WeakMap,z={get(t,e){if(!q.includes(e))return t[e];let n=L[e];return n||(n=L[e]=function(...a){D.set(this,v.get(this)[e](...a))}),n}};async function*G(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,z);for(v.set(n,e),m.set(n,T(e));e;)yield n,e=await(D.get(n)||e.continue()),D.delete(n)}function P(t,e){return e===Symbol.asyncIterator&&w(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&w(t,[IDBIndex,IDBObjectStore])}O(t=>({...t,get(e,n,a){return P(e,n)?G:t.get(e,n,a)},has(e,n){return P(e,n)||t.has(e,n)}}));const Y="clo-store",Z=1;let p=null;function k(){return p||(p=J(Y,Z,{upgrade(t){t.createObjectStore("states",{keyPath:"id"}).createIndex("by-updated","meta.updatedAt");const n=t.createObjectStore("sessions",{keyPath:"id"});n.createIndex("by-platform","platform"),n.createIndex("by-started","startedAt"),t.createObjectStore("config")}})),p}async function B(t){await(await k()).put("states",t)}async function M(t){return(await k()).get("states",t)}async function tt(){return(await(await k()).getAllFromIndex("states","by-updated")).reverse()}async function F(){return(await tt())[0]}let o=null;const l=new Map;chrome.runtime.onInstalled.addListener(async()=>{console.log("[CLO Background] Extension installed"),o=await F()||null,o||(o=x("New Task"),await B(o)),console.log("[CLO Background] Active state loaded:",o.id)});chrome.runtime.onStartup.addListener(async()=>{o=await F()||null});chrome.runtime.onMessage.addListener((t,e,n)=>(et(t,e,n).catch(a=>{console.error("[CLO Background] Message handler error:",a),n({error:a.message})}),!0));async function et(t,e,n){var a,i,d;switch(t.type){case"PLATFORM_DETECTED":{const{platform:r,url:s}=t.payload;(a=e.tab)!=null&&a.id&&l.set(e.tab.id,{platform:r,url:s}),console.log(`[CLO Background] Platform detected: ${r} at ${s}`),chrome.action.setBadgeText({text:r.slice(0,3).toUpperCase(),tabId:(i=e.tab)==null?void 0:i.id}),chrome.action.setBadgeBackgroundColor({color:nt(r),tabId:(d=e.tab)==null?void 0:d.id}),n({acknowledged:!0});break}case"TURN_CAPTURED":{const{turn:r,platform:s,model:c}=t.payload;o||(o=x("Auto-captured Task")),o=N(o,r,s,c),o.history.recentTurns.length>15&&(o=V(o)),await B(o),console.log(`[CLO Background] Turn ingested. Total: ${o.meta.totalTurns}`),ot({type:"HUD_UPDATE",payload:{totalTurns:o.meta.totalTurns,platforms:o.meta.platforms,models:o.meta.models,artifacts:o.artifacts.length,constraints:o.constraints.length,decisions:o.decisions.length},timestamp:Date.now(),source:"background"}),n({success:!0,totalTurns:o.meta.totalTurns});break}case"STATE_REQUEST":{n({state:o,activeTabs:Object.fromEntries(l)});break}case"INJECT_STATE":{const{tabId:r,stateId:s}=t.payload,c=s?await M(s):o;if(!c){n({error:"No state to inject"});return}const u=r||rt();if(!u){n({error:"No target tab found"});return}const y=l.get(u),j=(y==null?void 0:y.platform)||"unknown",g=_(c,j);chrome.tabs.sendMessage(u,{type:"INJECT_STATE",payload:{text:g.text},timestamp:Date.now(),source:"background"}),n({success:!0,tokenEstimate:g.tokenEstimate,method:g.method});break}case"EXPORT_STATE":{const{stateId:r}=t.payload,s=r?await M(r):o;n({state:s});break}case"IMPORT_STATE":{try{const{state:r}=t.payload;if(!r||typeof r!="object")throw new Error("Invalid state object");if(!r.id||!r.meta)throw new Error("State missing required fields");o=r,await B(r),console.log("[CLO Background] State imported successfully:",r.meta.title),n({success:!0,message:`Imported state: ${r.meta.title}`,stateId:r.id})}catch(r){const s=r instanceof Error?r.message:String(r);console.error("[CLO Background] Import failed:",s),n({success:!1,error:s})}break}default:n({error:`Unknown message type: ${t.type}`})}}function nt(t){return{chatgpt:"#10A37F",claude:"#D97757",gemini:"#4285F4",grok:"#000000",perplexity:"#20B8CD",deepseek:"#4D6BFE",kimi:"#6C5CE7",manus:"#FF6B35",copilot:"#7B68EE",you:"#7C3AED",poe:"#5A67D8",huggingchat:"#FFD21E",qwen:"#615AEF",mistral:"#FF7000",cohere:"#39594D",unknown:"#888888"}[t]||"#888888"}function rt(){for(const[t]of l)return t;return null}function ot(t){chrome.runtime.sendMessage(t).catch(()=>{})}chrome.tabs.onRemoved.addListener(t=>{l.delete(t)});chrome.tabs.onUpdated.addListener((t,e)=>{if(e.url){const n=l.get(t);n&&!e.url.includes(n.platform)&&l.delete(t)}});chrome.tabs.onActivated.addListener(async t=>{const e=t.tabId,n=l.get(e);if(n)try{await chrome.tabs.sendMessage(e,{type:"RESCAN",payload:{},timestamp:Date.now(),source:"background"}),console.log(`[CLO] Sent RESCAN to tab ${e} (${n.platform})`)}catch{}});
