const x={maxRecentTurns:10,targetTokenBudget:4e3,preserveCodeBlocks:!0,preserveToolCalls:!0};function f(e){return Math.ceil(e.length/4)}function P(e,r={}){const s={...x,...r},o=structuredClone(e),a=o.history.recentTurns;if(a.length<=s.maxRecentTurns)return o;const n=a.slice(0,a.length-s.maxRecentTurns),i=a.slice(a.length-s.maxRecentTurns),t=5,c=[];for(let l=0;l<n.length;l+=t)c.push(n.slice(l,l+t));const u=[...o.history.compressedSegments];let p=u.length;for(const l of c){const g=C(l,p,s);u.push(g),p++}return o.history.compressedSegments=u,o.history.recentTurns=i,o.meta.updatedAt=Date.now(),o}function C(e,r,s){const o=T(e,s),a=b(e),n=y(e),i=e.map(c=>c.content).join(" "),t=f(o)/f(i);return{id:`segment_${r}`,turnRange:[0,e.length-1],summary:o,keyDecisions:a,preservedInvariants:n,originalTurnCount:e.length,compressionRatio:Math.round(t*100)/100}}function T(e,r){const s=[];for(const o of e){const a=o.role==="user"?"USER":"ASSISTANT";if(o.role==="user"){const n=o.content.length>200?o.content.slice(0,200)+"...":o.content;s.push(`[${a}]: ${n}`)}if(o.role==="assistant"){if(r.preserveCodeBlocks&&o.codeBlocks.length>0)for(const t of o.codeBlocks){const c=t.code.length>500?t.code.slice(0,500)+`
// ... truncated`:t.code;s.push(`[${a} CODE${t.filename?` (${t.filename})`:""}]: \`\`\`${t.language}
${c}
\`\`\``)}if(r.preserveToolCalls&&o.toolCalls.length>0)for(const t of o.toolCalls)s.push(`[${a} TOOL]: Called ${t.name}(${JSON.stringify(t.arguments).slice(0,100)})`);const n=o.content.split(/[.!?]\s+/);n.length>0&&s.push(`[${a}]: ${n[0].slice(0,150)}...`);const i=n.filter(t=>/\b(important|note|key|critical|must|decision|constraint)\b/i.test(t));for(const t of i.slice(0,3))s.push(`[${a} KEY]: ${t.slice(0,200)}`)}}return s.join(`
`)}function b(e){const r=[],s=[/(?:decided|chose|selected|going with|opted for|will use)\s+(.+?)(?:\.|$)/gi,/(?:decision|approach|strategy):\s*(.+?)(?:\.|$)/gi,/(?:let's|we'll|i'll)\s+(.+?)(?:\.|$)/gi];for(const o of e)if(o.role==="assistant")for(const a of s){let n;for(;(n=a.exec(o.content))!==null;){const i=n[0].trim().slice(0,200);r.includes(i)||r.push(i)}}return r.slice(0,10)}function y(e){const r=[],s=[/(?:always|must always|never change|keep|maintain|preserve)\s+(.+?)(?:\.|$)/gi,/(?:requirement|constraint|invariant):\s*(.+?)(?:\.|$)/gi,/(?:do not|don't|cannot|must not)\s+(.+?)(?:\.|$)/gi];for(const o of e)for(const a of s){let n;for(;(n=a.exec(o.content))!==null;){const i=n[0].trim().slice(0,200);r.includes(i)||r.push(i)}}return r.slice(0,10)}function k(e,r=4e3){const s=[];s.push(`# Task Continuation Context (CLO v${e.schemaVersion})
**Task**: ${e.meta.title}
**Objective**: ${e.meta.objective}
**Total Turns**: ${e.meta.totalTurns} across ${e.meta.platforms.join(", ")}
**Models Used**: ${e.meta.models.join(", ")}
`);const o=e.constraints.filter(t=>t.active);if(o.length>0&&s.push(`## Active Constraints
`+o.map(t=>`- ${t.description}`).join(`
`)),e.decisions.length>0){const t=e.decisions.slice(-10);s.push(`## Key Decisions
`+t.map(c=>`- **${c.description}**: ${c.rationale}`).join(`
`))}e.artifacts.length>0&&s.push(`## Active Artifacts
`+e.artifacts.map(t=>`### ${t.name} (v${t.version}, ${t.type})
\`\`\`${t.language||""}
${t.content.slice(0,500)}
\`\`\``).join(`

`));const a=e.openQuestions.filter(t=>!t.resolved);if(a.length>0&&s.push(`## Unresolved Questions
`+a.map(t=>`- ${t.question}`).join(`
`)),e.nextAction&&s.push(`## Next Intended Action
${e.nextAction}`),e.history.compressedSegments.length>0&&s.push(`## Conversation Summary (Compressed)
`+e.history.compressedSegments.map(t=>`### Segment (${t.originalTurnCount} turns, ${t.compressionRatio}x compression)
${t.summary}`).join(`

`)),e.history.recentTurns.length>0){const t=e.history.recentTurns.slice(-5).map(c=>{const u=c.role==="user"?"USER":"ASSISTANT",p=c.content.length>300?c.content.slice(0,300)+"...":c.content;return`[${u}]: ${p}`}).join(`
`);s.push(`## Recent Conversation
${t}`)}let n=s.join(`

---

`);const i=f(n);if(i>r){const t=r/i;n=n.slice(0,Math.floor(n.length*t)),n+=`

[Context truncated to fit token budget]`}return n}const h={chatgpt:{platform:"chatgpt",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!0,supportsCodeExecution:!0,supportsFileUpload:!0,injectionMethod:"user_message"},claude:{platform:"claude",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:2e5,supportsToolCalls:!0,supportsCodeExecution:!1,supportsFileUpload:!0,injectionMethod:"user_message"},gemini:{platform:"gemini",supportsSystemPrompt:!0,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:1e6,supportsToolCalls:!0,supportsCodeExecution:!0,supportsFileUpload:!0,injectionMethod:"user_message"},grok:{platform:"grok",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!1,injectionMethod:"user_message"},perplexity:{platform:"perplexity",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!0,injectionMethod:"user_message"},deepseek:{platform:"deepseek",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!0,supportsCodeExecution:!0,supportsFileUpload:!0,injectionMethod:"user_message"},kimi:{platform:"kimi",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:2e5,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!0,injectionMethod:"user_message"},manus:{platform:"manus",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!0,supportsCodeExecution:!0,supportsFileUpload:!0,injectionMethod:"user_message"},copilot:{platform:"copilot",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!0,injectionMethod:"user_message"},you:{platform:"you",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!1,injectionMethod:"user_message"},poe:{platform:"poe",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"websocket",maxContextTokens:128e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!0,injectionMethod:"user_message"},huggingchat:{platform:"huggingchat",supportsSystemPrompt:!0,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:32e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!1,injectionMethod:"user_message"},qwen:{platform:"qwen",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!0,injectionMethod:"user_message"},mistral:{platform:"mistral",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!0,supportsCodeExecution:!1,supportsFileUpload:!1,injectionMethod:"user_message"},cohere:{platform:"cohere",supportsSystemPrompt:!1,supportsStreaming:!0,streamingProtocol:"sse",maxContextTokens:128e3,supportsToolCalls:!0,supportsCodeExecution:!1,supportsFileUpload:!0,injectionMethod:"user_message"},unknown:{platform:"unknown",supportsSystemPrompt:!1,supportsStreaming:!1,streamingProtocol:"unknown",maxContextTokens:4e3,supportsToolCalls:!1,supportsCodeExecution:!1,supportsFileUpload:!1,injectionMethod:"user_message"}};function S(e){return h[e]||h.unknown}function w(e,r){const s=S(r),o=Math.floor(s.maxContextTokens*.25),a=k(e,o),n=E(a);return{text:n,method:s.injectionMethod,tokenEstimate:Math.ceil(n.length/4)}}function E(e,r,s){return`[CONTEXT CONTINUATION — Injected by CLO (Cross-LLM Context Orchestrator)]
You are continuing a task that was previously worked on across multiple LLM sessions.
The following is a structured state snapshot. Treat it as ground truth for the task.
Do NOT re-derive or question the decisions below unless asked.
Resume from where the previous session left off.

`+e+`
---
[END OF INJECTED CONTEXT]
Please acknowledge this context and continue with the next action described above.`}function $(e,r){const s=v(r);for(const a of s){const n=document.querySelector(a);if(n){if(n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement)return d(n,e);if(n.getAttribute("contenteditable")==="true")return m(n,e);const i=n.querySelector('[contenteditable="true"]');if(i)return m(i,e);const t=n.querySelector("textarea");if(t)return d(t,e)}}const o=document.querySelector('main [contenteditable="true"], [role="textbox"], main textarea');if(o){if(o instanceof HTMLTextAreaElement)return d(o,e);if(o.getAttribute("contenteditable")==="true"||o.getAttribute("role")==="textbox")return m(o,e)}return!1}function d(e,r){var s;try{const o=(s=Object.getOwnPropertyDescriptor(e instanceof HTMLTextAreaElement?window.HTMLTextAreaElement.prototype:window.HTMLInputElement.prototype,"value"))==null?void 0:s.set;return o?o.call(e,r):e.value=r,e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new KeyboardEvent("keydown",{bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keyup",{bubbles:!0})),e.focus(),!0}catch(o){return console.warn("[CLO] Textarea injection failed:",o),!1}}function m(e,r){try{e.focus();const s=window.getSelection();if(s&&(s.selectAllChildren(e),s.deleteFromDocument()),!document.execCommand("insertText",!1,r))if(e.classList.contains("ProseMirror")||e.closest(".ProseMirror")!==null){const n=r.split(`
`).map(i=>{const t=document.createElement("p");return t.textContent=i||"​",t});e.innerHTML="";for(const i of n)e.appendChild(i)}else e.textContent=r;return e.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:r})),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new CompositionEvent("compositionstart",{bubbles:!0})),e.dispatchEvent(new CompositionEvent("compositionend",{bubbles:!0,data:r})),!0}catch(s){console.warn("[CLO] ContentEditable injection failed:",s);try{return e.textContent=r,e.dispatchEvent(new Event("input",{bubbles:!0})),!0}catch{return!1}}}function v(e){switch(e){case"chatgpt":return["#prompt-textarea",'[data-testid="text-input"]','textarea[data-id="root"]','[contenteditable="true"].ProseMirror','[contenteditable="true"]',"textarea"];case"claude":return['[contenteditable="true"].ProseMirror','fieldset [contenteditable="true"]','[contenteditable="true"]',"textarea"];case"gemini":return[".ql-editor",'rich-textarea [contenteditable="true"]','[contenteditable="true"]',"textarea[aria-label]","textarea"];case"grok":return["textarea[placeholder]",'[contenteditable="true"]',"textarea"];case"perplexity":return["textarea[placeholder]","textarea[autocomplete]",'[contenteditable="true"]','input[type="text"]',"textarea"];case"deepseek":return["#chat-input",'textarea[class*="chat"]',"textarea[placeholder]",'[contenteditable="true"]',"textarea"];case"kimi":return['textarea[class*="input"]',"textarea[placeholder]",'[contenteditable="true"]',"textarea"];case"manus":return['textarea[class*="input"]',"textarea[placeholder]",'[contenteditable="true"]','input[type="text"]',"textarea"];case"copilot":return["#searchbox","textarea[placeholder]",'[contenteditable="true"]',"textarea",'input[type="text"]'];case"you":return["textarea[placeholder]",'input[type="search"]','input[type="text"]','[contenteditable="true"]',"textarea"];case"poe":return['[class*="ChatMessageInput"] textarea','textarea[class*="TextInput"]',"textarea[placeholder]",'[contenteditable="true"]',"textarea"];case"huggingchat":return["textarea[placeholder]","textarea[enterkeyhint]",'[contenteditable="true"]',"textarea"];case"qwen":return['textarea[class*="input"]',"textarea[placeholder]",'[contenteditable="true"]',"textarea"];case"mistral":return["textarea[placeholder]",'[contenteditable="true"]',"textarea"];case"cohere":return["textarea[placeholder]",'[contenteditable="true"]',"textarea"];default:return['[contenteditable="true"]',"textarea[placeholder]","textarea",'input[type="text"]']}}export{P as c,$ as i,w as p};
