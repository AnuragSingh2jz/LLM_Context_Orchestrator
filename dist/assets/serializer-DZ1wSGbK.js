function m(){return crypto.randomUUID()}function A(r="Untitled Task"){const e=Date.now();return{id:m(),schemaVersion:"0.1.0",meta:{title:r,objective:"",createdAt:e,updatedAt:e,totalTurns:0,platforms:[],models:[]},constraints:[],decisions:[],artifacts:[],openQuestions:[],nextAction:"",history:{recentTurns:[],compressedSegments:[]},provenance:[]}}function g(r,e,n,s){const t=structuredClone(r),o=Date.now();t.history.recentTurns.push(e),t.meta.totalTurns++,t.meta.updatedAt=o,t.meta.platforms.includes(n)||t.meta.platforms.push(n),s&&!t.meta.models.includes(s)&&t.meta.models.push(s);for(const i of e.codeBlocks)y(t,i,e.id);if(e.role==="user"){const i=l(e.content,e.id);for(const a of i)t.constraints.some(c=>c.description===a.description)||t.constraints.push(a)}return h(t,n,s||"unknown",e.id),t}function l(r,e){const n=[],s=[/must\s+(.+?)(?:\.|$)/gi,/should\s+not\s+(.+?)(?:\.|$)/gi,/always\s+(.+?)(?:\.|$)/gi,/never\s+(.+?)(?:\.|$)/gi,/requirement:\s*(.+?)(?:\.|$)/gi,/constraint:\s*(.+?)(?:\.|$)/gi,/do\s+not\s+(.+?)(?:\.|$)/gi];for(const t of s){let o;for(;(o=t.exec(r))!==null;)n.push({id:m(),description:o[0].trim(),source:"inferred",turnId:e,active:!0})}return n}function y(r,e,n){const s=e.filename||`snippet_${r.artifacts.length+1}`,t=r.artifacts.find(o=>o.name===s);t?(t.content=e.code,t.version++,t.lastModifiedTurnId=n):r.artifacts.push({id:m(),name:s,type:e.filename?"file":"snippet",content:e.code,language:e.language,lastModifiedTurnId:n,version:1})}function h(r,e,n,s){const t=r.provenance.find(o=>o.platform===e&&o.model===n);t?(t.turnIds.push(s),t.timestamp=Date.now()):r.provenance.push({platform:e,model:n,turnIds:[s],timestamp:Date.now()})}function w(r){var s,t,o,i,a,c,p,u,f;let e;try{e=JSON.parse(r)}catch(d){throw new Error(`Failed to parse JSON: ${d instanceof Error?d.message:String(d)}`)}if(!e||typeof e!="object")throw new Error("Imported data must be a valid JSON object");if(e.schemaVersion!=="0.1.0")throw new Error(`Unsupported schema version: ${e.schemaVersion}. Expected 0.1.0`);if(!e.id||typeof e.id!="string")throw new Error("Missing required field: id");if(!e.meta||typeof e.meta!="object")throw new Error("Missing required field: meta");return{id:e.id,schemaVersion:e.schemaVersion,meta:{title:((s=e.meta)==null?void 0:s.title)||"Imported Task",objective:((t=e.meta)==null?void 0:t.objective)||"",createdAt:((o=e.meta)==null?void 0:o.createdAt)||Date.now(),updatedAt:((i=e.meta)==null?void 0:i.updatedAt)||Date.now(),totalTurns:((a=e.meta)==null?void 0:a.totalTurns)||0,platforms:Array.isArray((c=e.meta)==null?void 0:c.platforms)?e.meta.platforms:[],models:Array.isArray((p=e.meta)==null?void 0:p.models)?e.meta.models:[]},constraints:Array.isArray(e.constraints)?e.constraints:[],decisions:Array.isArray(e.decisions)?e.decisions:[],artifacts:Array.isArray(e.artifacts)?e.artifacts:[],openQuestions:Array.isArray(e.openQuestions)?e.openQuestions:[],nextAction:e.nextAction||"",history:{recentTurns:Array.isArray((u=e.history)==null?void 0:u.recentTurns)?e.history.recentTurns:[],compressedSegments:Array.isArray((f=e.history)==null?void 0:f.compressedSegments)?e.history.compressedSegments:[]},provenance:Array.isArray(e.provenance)?e.provenance:[]}}export{g as a,A as c,w as i};
