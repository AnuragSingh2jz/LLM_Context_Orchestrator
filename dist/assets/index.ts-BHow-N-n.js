var b=Object.defineProperty;var y=(n,s,t)=>s in n?b(n,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[s]=t;var u=(n,s,t)=>y(n,typeof s!="symbol"?s+"":s,t);import{i as w}from"./injector-DGr5dEOY.js";class g{constructor(){u(this,"observer",null);u(this,"turnCallbacks",[]);u(this,"turnCounter",0)}stop(){this.observer&&(this.observer.disconnect(),this.observer=null)}onTurn(s){this.turnCallbacks.push(s)}emitTurn(s){for(const t of this.turnCallbacks)t(s)}createTurn(s,t,e){return this.turnCounter++,{id:`${this.platform}_turn_${this.turnCounter}_${Date.now()}`,role:s,content:t,timestamp:Date.now(),model:e,codeBlocks:this.extractCodeBlocks(t),toolCalls:[]}}extractCodeBlocks(s){const t=[],e=/```(\w*)\n([\s\S]*?)```/g;let o;for(;(o=e.exec(s))!==null;)t.push({language:o[1]||"text",code:o[2].trim()});return t}detectModel(){}observeContainer(s,t,e){let o=s.querySelectorAll(t).length;this.observer=new MutationObserver(()=>{const c=s.querySelectorAll(t);if(c.length>o){for(let r=o;r<c.length;r++){const l=c[r],m=e(l);if(m){const h=this.extractTextContent(l);if(h.trim()){const C=this.createTurn(m,h,this.detectModel());this.emitTurn(C)}}}o=c.length}}),this.observer.observe(s,{childList:!0,subtree:!0})}extractTextContent(s){var o,c;const t=s.cloneNode(!0),e=t.querySelectorAll("pre code, pre");for(const r of e){const l=((c=(o=r.className)==null?void 0:o.split(" ").find(m=>m.startsWith("language-")))==null?void 0:c.replace("language-",""))||"";r.textContent=`\`\`\`${l}
${r.textContent}
\`\`\``}return t.textContent||""}}class x extends g{constructor(){super(...arguments);u(this,"platform","chatgpt")}start(){console.log("[CLO] ChatGPT interceptor started"),this.waitForConversationContainer()}waitForConversationContainer(){const t=()=>{const e=document.querySelector('main [class*="react-scroll-to-bottom"]')||document.querySelector("main .flex.flex-col");e?(this.observeContainer(e,"[data-message-author-role]",this.detectRole.bind(this)),this.captureExistingMessages(e)):setTimeout(t,1e3)};t()}detectRole(t){const e=t.getAttribute("data-message-author-role");return e==="user"?"user":e==="assistant"?"assistant":e==="system"?"system":e==="tool"?"tool":null}detectModel(){const t=document.querySelector('[data-testid="model-switcher"] button span')||document.querySelector('button[aria-label] span[class*="text"]');if(t!=null&&t.textContent){const e=t.textContent.trim().toLowerCase();return e.includes("4o")?"gpt-4o":e.includes("4")?"gpt-4":e.includes("o1")?"o1":e.includes("o3")?"o3-mini":e}return"chatgpt-unknown"}captureExistingMessages(t){const e=t.querySelectorAll("[data-message-author-role]");for(const o of e){const c=this.detectRole(o);if(c){const r=this.extractTextContent(o);r.trim()&&this.createTurn(c,r,this.detectModel())}}}}class S extends g{constructor(){super(...arguments);u(this,"platform","claude")}start(){console.log("[CLO] Claude interceptor started"),this.waitForConversationContainer()}waitForConversationContainer(){const t=()=>{const e=document.querySelector('[class*="conversation-content"]')||document.querySelector('[data-testid="conversation-turn-list"]')||document.querySelector("main .flex.flex-col");e?this.observeContainer(e,'[class*="Message"], [data-testid*="message"]',this.detectRole.bind(this)):setTimeout(t,1e3)};t()}detectRole(t){const e=t.className||"",o=t.getAttribute("data-testid")||"";if(e.includes("human")||o.includes("human")||o.includes("user"))return"user";if(e.includes("assistant")||o.includes("assistant")||o.includes("ai"))return"assistant";const c=t.querySelector('[class*="avatar"], [class*="icon"]');if(c){const r=c.className||"";if(r.includes("human")||r.includes("user"))return"user";if(r.includes("assistant")||r.includes("ai"))return"assistant"}return null}detectModel(){const t=document.querySelector('[data-testid="model-selector"] button')||document.querySelector('button[class*="model"]');if(t!=null&&t.textContent){const e=t.textContent.trim().toLowerCase();return e.includes("opus")?"claude-3-opus":e.includes("sonnet")?"claude-3.5-sonnet":e.includes("haiku")?"claude-3-haiku":e}return"claude-unknown"}}class T extends g{constructor(){super(...arguments);u(this,"platform","gemini")}start(){console.log("[CLO] Gemini interceptor started"),this.waitForConversationContainer()}waitForConversationContainer(){const t=()=>{const e=document.querySelector("chat-window")||document.querySelector('[class*="conversation"]')||document.querySelector("main");e?this.observeContainer(e,"message-content, [class*='message-content'], model-response, user-query",this.detectRole.bind(this)):setTimeout(t,1e3)};t()}detectRole(t){const e=t.tagName.toLowerCase();if(e==="user-query"||e.includes("user"))return"user";if(e==="model-response"||e.includes("model"))return"assistant";const o=t.className||"";if(o.includes("user")||o.includes("query"))return"user";if(o.includes("model")||o.includes("response"))return"assistant";const c=t.closest("[class*='user'], [class*='model']");if(c){const r=c.className||"";if(r.includes("user"))return"user";if(r.includes("model"))return"assistant"}return null}detectModel(){const t=document.querySelector('[class*="model-picker"]')||document.querySelector('[aria-label*="model"]');if(t!=null&&t.textContent){const e=t.textContent.trim().toLowerCase();return e.includes("2.0 flash")?"gemini-2.0-flash":e.includes("2.0 pro")?"gemini-2.0-pro":e.includes("1.5 pro")?"gemini-1.5-pro":e.includes("ultra")?"gemini-ultra":e}return"gemini-unknown"}}const L=[{platform:"chatgpt",patterns:[/chatgpt\.com/i,/chat\.openai\.com/i]},{platform:"claude",patterns:[/claude\.ai/i]},{platform:"gemini",patterns:[/gemini\.google\.com/i]},{platform:"grok",patterns:[/grok\.x\.ai/i,/x\.com\/i\/grok/i]}];function q(n){const s=window.location.href;for(const{platform:t,patterns:e}of L)for(const o of e)if(o.test(s))return t;return"unknown"}function k(n){switch(n){case"chatgpt":return new x;case"claude":return new S;case"gemini":return new T;case"grok":return console.log("[CLO] Grok interceptor not yet implemented, using generic"),null;default:return null}}let a=null,f=!1;function E(){if(a)return;a=document.createElement("div"),a.id="clo-hud",a.innerHTML=`
    <button id="clo-hud-toggle" title="CLO ‚Äî Cross-LLM Context Orchestrator">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
      </svg>
    </button>
    <div id="clo-hud-panel">
      <div class="clo-header">
        <span class="clo-logo">CLO</span>
        <span class="clo-status-dot" id="clo-status-dot"></span>
        <span style="flex:1"></span>
        <span style="font-size:10px;color:rgba(255,255,255,0.3);font-family:var(--clo-font-mono)">v0.1</span>
      </div>
      <div class="clo-platform" id="clo-platform-info">
        <span class="clo-platform-dot" id="clo-platform-dot"></span>
        <span id="clo-platform-name">Detecting...</span>
      </div>
      <div class="clo-stats">
        <div class="clo-stat">
          <div class="clo-stat-value" id="clo-stat-turns">0</div>
          <div class="clo-stat-label">Turns</div>
        </div>
        <div class="clo-stat">
          <div class="clo-stat-value" id="clo-stat-artifacts">0</div>
          <div class="clo-stat-label">Artifacts</div>
        </div>
        <div class="clo-stat">
          <div class="clo-stat-value" id="clo-stat-constraints">0</div>
          <div class="clo-stat-label">Constraints</div>
        </div>
        <div class="clo-stat">
          <div class="clo-stat-value" id="clo-stat-decisions">0</div>
          <div class="clo-stat-label">Decisions</div>
        </div>
      </div>
      <div class="clo-actions">
        <button class="clo-btn primary" id="clo-btn-inject">‚ö° Inject</button>
        <button class="clo-btn" id="clo-btn-export">üì§ Export</button>
        <button class="clo-btn" id="clo-btn-view">üëÅ View</button>
      </div>
    </div>
  `,document.body.appendChild(a);const n=a.querySelector("#clo-hud-toggle");n==null||n.addEventListener("click",()=>{f=!f,a==null||a.classList.toggle("minimized",f)});const s=a.querySelector("#clo-btn-inject");s==null||s.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"INJECT_STATE",payload:{},timestamp:Date.now(),source:"content"})});const t=a.querySelector("#clo-btn-export");t==null||t.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"EXPORT_STATE",payload:{},timestamp:Date.now(),source:"content"},o=>{if(o!=null&&o.state){const c=new Blob([JSON.stringify(o.state,null,2)],{type:"application/json"}),r=URL.createObjectURL(c),l=document.createElement("a");l.href=r,l.download=`clo-state-${Date.now()}.json`,l.click(),URL.revokeObjectURL(r),d("State exported ‚úì","success")}})});const e=a.querySelector("#clo-btn-view");e==null||e.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"STATE_REQUEST",payload:{},timestamp:Date.now(),source:"content"},o=>{o!=null&&o.state&&(console.log("[CLO] Current Reasoning State:",o.state),d("State logged to console","info"))})})}function p(n){if(!a)return;const s=a.querySelector("#clo-platform-name"),t=a.querySelector("#clo-platform-dot");s&&(s.textContent=M(n.platform)),t&&(t.className=`clo-platform-dot ${n.platform}`);const e=a.querySelector("#clo-status-dot");e&&(e.className="clo-status-dot",n.status==="unsupported"&&e.classList.add("warning"),n.status==="idle"&&e.classList.add("error"));const o=a.querySelector("#clo-stat-turns");o&&(o.textContent=String(n.turns))}function d(n,s="info"){const t=document.querySelector("#clo-notification");t&&t.remove();const e=document.createElement("div");e.id="clo-notification",e.className=s,e.textContent=n,document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),setTimeout(()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),400)},3e3)}function M(n){return n.charAt(0).toUpperCase()+n.slice(1)}const i=q();i==="unknown"?console.log("[CLO] Not a supported platform, exiting."):(console.log(`[CLO] Detected platform: ${i}`),O());function O(){E(),p({platform:i,status:"active",turns:0}),d(`CLO active on ${i}`,"info"),v({type:"PLATFORM_DETECTED",payload:{platform:i,url:window.location.href},timestamp:Date.now(),source:"content"});const n=k(i);let s=0;n?(n.onTurn(t=>{s++,console.log(`[CLO] Captured turn #${s}:`,t.role,t.content.slice(0,100)),p({platform:i,status:"capturing",turns:s}),v({type:"TURN_CAPTURED",payload:{turn:t,platform:i,model:t.model},timestamp:Date.now(),source:"content"})}),n.start()):(p({platform:i,status:"unsupported",turns:0}),d(`Platform "${i}" not fully supported yet`,"warning")),chrome.runtime.onMessage.addListener((t,e,o)=>{if(t.type==="INJECT_STATE"){const{text:c}=t.payload,r=w(c,i);d(r?"Context injected ‚úì":"Injection failed ‚Äî input not found",r?"success":"error"),o({success:r})}return!0})}function v(n){try{chrome.runtime.sendMessage(n)}catch(s){console.warn("[CLO] Failed to send message:",s)}}
