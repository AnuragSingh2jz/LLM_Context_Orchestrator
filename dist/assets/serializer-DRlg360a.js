function a(){return crypto.randomUUID()}function m(n="Untitled Task"){const t=Date.now();return{id:a(),schemaVersion:"0.1.0",meta:{title:n,objective:"",createdAt:t,updatedAt:t,totalTurns:0,platforms:[],models:[]},constraints:[],decisions:[],artifacts:[],openQuestions:[],nextAction:"",history:{recentTurns:[],compressedSegments:[]},provenance:[]}}function l(n,t,s,o){const e=structuredClone(n),i=Date.now();e.history.recentTurns.push(t),e.meta.totalTurns++,e.meta.updatedAt=i,e.meta.platforms.includes(s)||e.meta.platforms.push(s),o&&!e.meta.models.includes(o)&&e.meta.models.push(o);for(const r of t.codeBlocks)p(e,r,t.id);if(t.role==="user"){const r=d(t.content,t.id);for(const c of r)e.constraints.some(u=>u.description===c.description)||e.constraints.push(c)}return f(e,s,o||"unknown",t.id),e}function d(n,t){const s=[],o=[/must\s+(.+?)(?:\.|$)/gi,/should\s+not\s+(.+?)(?:\.|$)/gi,/always\s+(.+?)(?:\.|$)/gi,/never\s+(.+?)(?:\.|$)/gi,/requirement:\s*(.+?)(?:\.|$)/gi,/constraint:\s*(.+?)(?:\.|$)/gi,/do\s+not\s+(.+?)(?:\.|$)/gi];for(const e of o){let i;for(;(i=e.exec(n))!==null;)s.push({id:a(),description:i[0].trim(),source:"inferred",turnId:t,active:!0})}return s}function p(n,t,s){const o=t.filename||`snippet_${n.artifacts.length+1}`,e=n.artifacts.find(i=>i.name===o);e?(e.content=t.code,e.version++,e.lastModifiedTurnId=s):n.artifacts.push({id:a(),name:o,type:t.filename?"file":"snippet",content:t.code,language:t.language,lastModifiedTurnId:s,version:1})}function f(n,t,s,o){const e=n.provenance.find(i=>i.platform===t&&i.model===s);e?(e.turnIds.push(o),e.timestamp=Date.now()):n.provenance.push({platform:t,model:s,turnIds:[o],timestamp:Date.now()})}function h(n){const t=JSON.parse(n);if(t.schemaVersion!=="0.1.0")throw new Error(`Unsupported schema version: ${t.schemaVersion}`);return t}export{l as a,m as c,h as i};
