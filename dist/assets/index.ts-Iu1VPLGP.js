import{c as x,a as _}from"./serializer-DRlg360a.js";import{p as F,c as V}from"./injector-DGr5dEOY.js";const I=(t,e)=>e.some(n=>t instanceof n);let P,S;function U(){return P||(P=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function W(){return S||(S=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const w=new WeakMap,b=new WeakMap,m=new WeakMap;function $(t){const e=new Promise((n,a)=>{const c=()=>{t.removeEventListener("success",d),t.removeEventListener("error",r)},d=()=>{n(l(t.result)),c()},r=()=>{a(t.error),c()};t.addEventListener("success",d),t.addEventListener("error",r)});return m.set(e,t),e}function K(t){if(w.has(t))return;const e=new Promise((n,a)=>{const c=()=>{t.removeEventListener("complete",d),t.removeEventListener("error",r),t.removeEventListener("abort",r)},d=()=>{n(),c()},r=()=>{a(t.error||new DOMException("AbortError","AbortError")),c()};t.addEventListener("complete",d),t.addEventListener("error",r),t.addEventListener("abort",r)});w.set(t,e)}let p={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return w.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return l(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function O(t){p=t(p)}function H(t){return W().includes(t)?function(...e){return t.apply(E(this),e),l(this.request)}:function(...e){return l(t.apply(E(this),e))}}function J(t){return typeof t=="function"?H(t):(t instanceof IDBTransaction&&K(t),I(t,U())?new Proxy(t,p):t)}function l(t){if(t instanceof IDBRequest)return $(t);if(b.has(t))return b.get(t);const e=J(t);return e!==t&&(b.set(t,e),m.set(e,t)),e}const E=t=>m.get(t);function R(t,e,{blocked:n,upgrade:a,blocking:c,terminated:d}={}){const r=indexedDB.open(t,e),i=l(r);return a&&r.addEventListener("upgradeneeded",s=>{a(l(r.result),s.oldVersion,s.newVersion,l(r.transaction),s)}),n&&r.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),i.then(s=>{d&&s.addEventListener("close",()=>d()),c&&s.addEventListener("versionchange",u=>c(u.oldVersion,u.newVersion,u))}).catch(()=>{}),i}const Q=["get","getKey","getAll","getAllKeys","count"],X=["put","add","delete","clear"],g=new Map;function A(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(g.get(e))return g.get(e);const n=e.replace(/FromIndex$/,""),a=e!==n,c=X.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!(c||Q.includes(n)))return;const d=async function(r,...i){const s=this.transaction(r,c?"readwrite":"readonly");let u=s.store;return a&&(u=u.index(i.shift())),(await Promise.all([u[n](...i),c&&s.done]))[0]};return g.set(e,d),d}O(t=>({...t,get:(e,n,a)=>A(e,n)||t.get(e,n,a),has:(e,n)=>!!A(e,n)||t.has(e,n)}));const z=["continue","continuePrimaryKey","advance"],C={},D=new WeakMap,v=new WeakMap,G={get(t,e){if(!z.includes(e))return t[e];let n=C[e];return n||(n=C[e]=function(...a){D.set(this,v.get(this)[e](...a))}),n}};async function*Y(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,G);for(v.set(n,e),m.set(n,E(e));e;)yield n,e=await(D.get(n)||e.continue()),D.delete(n)}function L(t,e){return e===Symbol.asyncIterator&&I(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&I(t,[IDBIndex,IDBObjectStore])}O(t=>({...t,get(e,n,a){return L(e,n)?Y:t.get(e,n,a)},has(e,n){return L(e,n)||t.has(e,n)}}));const Z="clo-store",q=1;let T=null;function k(){return T||(T=R(Z,q,{upgrade(t){t.createObjectStore("states",{keyPath:"id"}).createIndex("by-updated","meta.updatedAt");const n=t.createObjectStore("sessions",{keyPath:"id"});n.createIndex("by-platform","platform"),n.createIndex("by-started","startedAt"),t.createObjectStore("config")}})),T}async function B(t){await(await k()).put("states",t)}async function M(t){return(await k()).get("states",t)}async function tt(){return(await(await k()).getAllFromIndex("states","by-updated")).reverse()}async function j(){return(await tt())[0]}let o=null;const f=new Map;chrome.runtime.onInstalled.addListener(async()=>{console.log("[CLO Background] Extension installed"),o=await j()||null,o||(o=x("New Task"),await B(o)),console.log("[CLO Background] Active state loaded:",o.id)});chrome.runtime.onStartup.addListener(async()=>{o=await j()||null});chrome.runtime.onMessage.addListener((t,e,n)=>(et(t,e,n).catch(a=>{console.error("[CLO Background] Message handler error:",a),n({error:a.message})}),!0));async function et(t,e,n){var a,c,d;switch(t.type){case"PLATFORM_DETECTED":{const{platform:r,url:i}=t.payload;(a=e.tab)!=null&&a.id&&f.set(e.tab.id,{platform:r,url:i}),console.log(`[CLO Background] Platform detected: ${r} at ${i}`),chrome.action.setBadgeText({text:r.slice(0,3).toUpperCase(),tabId:(c=e.tab)==null?void 0:c.id}),chrome.action.setBadgeBackgroundColor({color:nt(r),tabId:(d=e.tab)==null?void 0:d.id}),n({acknowledged:!0});break}case"TURN_CAPTURED":{const{turn:r,platform:i,model:s}=t.payload;o||(o=x("Auto-captured Task")),o=_(o,r,i,s),o.history.recentTurns.length>15&&(o=V(o)),await B(o),console.log(`[CLO Background] Turn ingested. Total: ${o.meta.totalTurns}`),ot({type:"HUD_UPDATE",payload:{totalTurns:o.meta.totalTurns,platforms:o.meta.platforms,models:o.meta.models,artifacts:o.artifacts.length,constraints:o.constraints.length,decisions:o.decisions.length},timestamp:Date.now(),source:"background"}),n({success:!0,totalTurns:o.meta.totalTurns});break}case"STATE_REQUEST":{n({state:o,activeTabs:Object.fromEntries(f)});break}case"INJECT_STATE":{const{tabId:r,stateId:i}=t.payload,s=i?await M(i):o;if(!s){n({error:"No state to inject"});return}const u=r||rt();if(!u){n({error:"No target tab found"});return}const y=f.get(u),N=(y==null?void 0:y.platform)||"unknown",h=F(s,N);chrome.tabs.sendMessage(u,{type:"INJECT_STATE",payload:{text:h.text},timestamp:Date.now(),source:"background"}),n({success:!0,tokenEstimate:h.tokenEstimate,method:h.method});break}case"EXPORT_STATE":{const{stateId:r}=t.payload,i=r?await M(r):o;n({state:i});break}case"IMPORT_STATE":{const{state:r}=t.payload;o=r,await B(r),n({success:!0});break}default:n({error:`Unknown message type: ${t.type}`})}}function nt(t){return{chatgpt:"#10A37F",claude:"#D97757",gemini:"#4285F4",grok:"#000000",unknown:"#888888"}[t]}function rt(){for(const[t]of f)return t;return null}function ot(t){chrome.runtime.sendMessage(t).catch(()=>{})}chrome.tabs.onRemoved.addListener(t=>{f.delete(t)});chrome.tabs.onUpdated.addListener((t,e)=>{if(e.url){const n=f.get(t);n&&!e.url.includes(n.platform)&&f.delete(t)}});
